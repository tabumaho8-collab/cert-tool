<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šå‹¤è²»ç²¾ç®—æ›¸ (é«˜æ©Ÿèƒ½ç‰ˆ)</title>
    <style>
        body { display: none; font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f4f4f4; margin: 0; padding: 20px; gap: 20px; justify-content: center; min-height: 100vh; }
        .editor-pane { width: 400px; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); height: fit-content; overflow-y: auto; max-height: 90vh; }
        .back-btn { display: inline-block; background-color: #6c757d; color: white; padding: 5px 10px; text-decoration: none; border-radius: 4px; font-size: 12px; margin-bottom: 15px; cursor: pointer; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 5px; color: #555; }
        .form-group input, .form-group select { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        
        /* çµŒè·¯ç™»éŒ²ã‚¨ãƒªã‚¢ */
        .route-master-box { background: #e3f2fd; padding: 10px; border-radius: 4px; border: 1px solid #90caf9; margin-bottom: 20px; }
        .route-list-item { display: flex; justify-content: space-between; font-size: 12px; border-bottom: 1px dashed #ccc; padding: 3px 0; }
        .btn-mini { padding: 2px 6px; font-size: 10px; border-radius: 3px; border:none; cursor: pointer; color:white; }
        .btn-del { background-color: #d9534f; }
        .btn-add { background-color: #17a2b8; width: 100%; padding: 8px; font-weight: bold; margin-top: 5px;}

        /* ä¸€æ‹¬æ“ä½œãƒœã‚¿ãƒ³ */
        .bulk-action { background-color: #28a745; color: white; border: none; padding: 8px; width: 100%; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 5px; }

        button.print-btn { width: 100%; padding: 12px; background-color: #0056b3; color: white; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; font-weight: bold; margin-top: 20px; }
        
        .preview-pane { flex-grow: 1; display: flex; justify-content: center; }
        #sheet { width: 210mm; min-height: 297mm; background: white; padding: 15mm; box-sizing: border-box; box-shadow: 0 5px 15px rgba(0,0,0,0.2); position: relative; font-family: "Yu Mincho", "YuMincho", serif; color: #333; }
        
        /* ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .s-title { text-align: center; font-size: 24px; font-weight: bold; border-bottom: 2px solid #333; padding-bottom: 5px; margin-bottom: 15px; }
        .s-header { display: flex; justify-content: space-between; margin-bottom: 10px; align-items: flex-end; }
        .s-info { font-size: 13px; line-height: 1.6; }
        .s-hanko-box { display: flex; border: 1px solid #333; }
        .s-hanko { width: 50px; height: 50px; border-left: 1px solid #333; position: relative; }
        .s-hanko:first-child { border-left: none; }
        .s-hanko-title { border-bottom: 1px solid #333; font-size: 10px; text-align: center; background: #f0f0f0; }

        .total-bar { display: flex; justify-content: space-between; background: #f0f0f0; padding: 5px 10px; border: 1px solid #333; border-bottom: none; font-weight: bold; font-size: 14px; }

        .c-table { width: 100%; border-collapse: collapse; font-size: 11px; border: 1px solid #333; }
        .c-table th, .c-table td { border: 1px solid #333; padding: 2px 4px; vertical-align: middle; }
        .c-table th { background: #ddd; text-align: center; font-weight: normal; }
        
        /* åˆ—å¹… */
        .col-date { width: 30px; text-align: center; }
        .col-week { width: 20px; text-align: center; }
        .col-check { width: 30px; text-align: center; background: #e3f2fd; cursor: pointer; }
        .col-route { }
        .col-price { width: 60px; text-align: right; }
        .col-note { width: 80px; }

        /* ä¸Šä¸‹åˆ†å‰²ã‚¹ã‚¿ã‚¤ãƒ« */
        .split-cell { display: flex; flex-direction: column; gap: 0; }
        .split-top { border-bottom: 1px dashed #ccc; padding-bottom: 2px; }
        .split-bottom { padding-top: 2px; }
        
        /* ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼ˆå°åˆ·æ™‚ã¯æ¶ˆã™ï¼‰ */
        .route-select { width: 100%; font-size: 10px; border: 1px solid #eee; margin-bottom: 1px; background: transparent; }
        
        /* çŠ¶æ…‹ã”ã¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .row-off { background-color: #f9f9f9; color: #aaa; }
        .row-sun { color: red; }
        .row-sat { color: blue; }
        
        .ipt-note { width: 100%; border: none; background: transparent; font-size: 10px; }

        @media print {
            body { display: block !important; background: none; margin: 0; padding: 0; }
            .editor-pane { display: none; }
            .preview-pane { display: block; }
            #sheet { box-shadow: none; width: 100%; height: 100%; margin: 0; padding: 15mm; page-break-after: always; }
            /* å°åˆ·æ™‚ã«ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®æ ã‚’æ¶ˆã™ */
            .route-select { border: none; appearance: none; -webkit-appearance: none; padding: 0; }
            .col-check { background: none !important; color: transparent !important; } /* ãƒã‚§ãƒƒã‚¯åˆ—ã¯è‰²ã‚’æ¶ˆã™ */
            .col-check::after { content: ""; color: transparent; } /* å‡º/ä¼‘ã®æ–‡å­—ã‚‚æ¶ˆã™ãªã‚‰ã“ã“èª¿æ•´ */
            @page { margin: 0; size: A4 portrait; }
        }
    </style>
</head>
<body>
    <script src="auth.js"></script>
    <script src="settings.js"></script>
    <script>
        if (typeof checkAuth === 'function') checkAuth(); else document.body.style.display = "flex";
    </script>

    <div class="editor-pane">
        <a href="index.html" class="back-btn">â¬… ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a>
        <h2>é€šå‹¤è²»ç²¾ç®—æ›¸ (æœˆåˆ¥ä¿å­˜)</h2>
        
        <div class="form-group" style="background:#fff3cd; padding:10px; border-radius:4px;">
            <label>ğŸ“… ä½œæˆæœˆã‚’é¸æŠ (è‡ªå‹•ä¿å­˜)</label>
            <input type="month" id="iptMonthPicker" onchange="changeMonth()">
        </div>

        <div class="form-group">
            <label>ç”³è«‹è€…å (ä¿å­˜ã•ã‚Œã¾ã™)</label>
            <div style="display:flex; gap:5px;">
                <input type="text" id="iptUserDept" placeholder="éƒ¨ç½²">
                <input type="text" id="iptUserName" placeholder="æ°å">
            </div>
            <button class="btn-mini" style="background:#6c757d; margin-top:5px; width:100%;" onclick="saveUserInfo()">ã“ã®ç”³è«‹è€…æƒ…å ±ã‚’ä¿å­˜</button>
        </div>

        <div class="route-master-box">
            <label>ğŸš— çµŒè·¯ãƒ‘ã‚¿ãƒ¼ãƒ³ç™»éŒ²</label>
            <p style="font-size:10px; color:#666; margin:0;">ã‚ˆãä½¿ã†ç‰‡é“ã®çµŒè·¯ã¨é‡‘é¡ã‚’ç™»éŒ²ã—ã¦ãã ã•ã„ã€‚</p>
            <div id="routeList"></div>
            <div style="display:flex; gap:5px; margin-top:5px;">
                <input type="text" id="newRouteName" placeholder="ä¾‹: è‡ªå®…â†’ä¼šç¤¾(é«˜é€Ÿ)" style="flex:2;">
                <input type="number" id="newRoutePrice" placeholder="Â¥" style="flex:1;">
            </div>
            <button class="btn-add" onclick="addRouteMaster()">ï¼‹ çµŒè·¯ã‚’è¿½åŠ </button>
        </div>

        <div class="form-group">
            <label>ä¸€æ‹¬è¨­å®š (å¹³æ—¥ã®ã¿)</label>
            <select id="bulkOutward" style="margin-bottom:5px;"><option value="">è¡Œã: é¸æŠãªã—</option></select>
            <select id="bulkReturn"><option value="">å¸°ã‚Š: é¸æŠãªã—</option></select>
            <button class="bulk-action" onclick="applyBulk()">å¹³æ—¥ã‚’ä¸€æ‹¬è¨­å®šã™ã‚‹</button>
        </div>

        <button class="print-btn" onclick="window.print()">ğŸ–¨ï¸ å°åˆ·ã™ã‚‹</button>
    </div>

    <div class="preview-pane">
        <div id="sheet">
            <div class="s-title">é€šå‹¤è²»ç²¾ç®—æ›¸</div>
            
            <div class="s-header">
                <div class="s-info">
                    å¯¾è±¡æœˆï¼š<span id="viewTargetMonth"></span><br>
                    æ‰€ã€€å±ï¼š<span id="viewDept"></span><br>
                    æ°ã€€åï¼š<span id="viewName"></span>
                    <div style="margin-top:5px; position:relative; width:50px; height:50px;">
                        <img id="viewSeal" src="" style="width:100%; height:100%; object-fit:contain; display:none; opacity:0.8;">
                        <div style="position:absolute; top:0; left:0; width:100%; height:100%; border:1px solid #ccc; display:flex; align-items:center; justify-content:center; color:#ccc; z-index:-1; font-size:10px;">(å°)</div>
                    </div>
                </div>
                
                <div class="s-hanko-box">
                    <div class="s-hanko"><div class="s-hanko-title">æ‰¿èª</div></div>
                    <div class="s-hanko"><div class="s-hanko-title">ç¢ºèª</div></div>
                    <div class="s-hanko"><div class="s-hanko-title">æ‹…å½“</div></div>
                </div>
            </div>

            <div class="total-bar">
                <div>å‡ºå‹¤ï¼š<span id="viewDays">0</span> æ—¥</div>
                <div>åˆè¨ˆï¼šÂ¥<span id="viewTotal">0</span></div>
            </div>

            <table class="c-table">
                <thead>
                    <tr>
                        <th class="col-date">æ—¥</th>
                        <th class="col-week">æ›œ</th>
                        <th class="col-check">å‡ºå‹¤</th>
                        <th class="col-route">åŒºé–“ãƒ»çµŒè·¯ (ä¸Š:è¡Œã / ä¸‹:å¸°ã‚Š)</th>
                        <th class="col-price">é‡‘é¡</th>
                        <th class="col-note">å‚™è€ƒ</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    <!-- JSã§ç”Ÿæˆ -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const KEY_USER = "my_tool_tsukin_user";
        const KEY_ROUTES = "my_tool_tsukin_routes";
        const KEY_DATA_PREFIX = "my_tool_tsukin_data_"; // + "2025-12"

        let routeMaster = [];
        let monthData = {}; // ãã®æœˆã®æ—¥åˆ¥ãƒ‡ãƒ¼ã‚¿ { "1": {on:true, out:0, ret:0, note:""}, ... }
        
        // ç¥æ—¥ãƒ‡ãƒ¼ã‚¿ (ç°¡æ˜“)
        const HOLIDAYS = ["1-1", "1-2", "1-3", "2-11", "2-23", "3-20", "4-29", "5-3", "5-4", "5-5", "7-15", "8-11", "9-16", "9-23", "10-14", "11-3", "11-23"];

        window.addEventListener('load', function() {
            // åˆæœŸæœˆè¨­å®š (ä»Šæœˆ)
            const d = new Date();
            const ym = d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,'0');
            document.getElementById('iptMonthPicker').value = ym;

            if (typeof applyCompanyData === 'function') applyCompanyData();
            loadUserInfo();
            loadRouteMaster();
            changeMonth(); // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼†æç”»
            
            setTimeout(() => {
                const img = document.getElementById('viewSeal');
                if(img.src && img.src.length > 10) img.style.display = 'block';
            }, 500);
        });

        // --- ç”³è«‹è€…æƒ…å ± ---
        function saveUserInfo() {
            const data = {
                dept: document.getElementById('iptUserDept').value,
                name: document.getElementById('iptUserName').value
            };
            localStorage.setItem(KEY_USER, JSON.stringify(data));
            alert("ç”³è«‹è€…æƒ…å ±ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
            updateHeader();
        }
        function loadUserInfo() {
            const json = localStorage.getItem(KEY_USER);
            if(json) {
                const data = JSON.parse(json);
                document.getElementById('iptUserDept').value = data.dept;
                document.getElementById('iptUserName').value = data.name;
                updateHeader();
            }
        }
        function updateHeader() {
            document.getElementById('viewDept').innerText = document.getElementById('iptUserDept').value;
            document.getElementById('viewName').innerText = document.getElementById('iptUserName').value;
        }

        // --- çµŒè·¯ãƒã‚¹ã‚¿ ---
        function loadRouteMaster() {
            const json = localStorage.getItem(KEY_ROUTES);
            if(json) routeMaster = JSON.parse(json);
            else routeMaster = []; // åˆæœŸå€¤ãªã—
            renderRouteMaster();
            updateSelectOptions();
        }
        function addRouteMaster() {
            const name = document.getElementById('newRouteName').value;
            const price = parseInt(document.getElementById('newRoutePrice').value);
            if(!name || isNaN(price)) return alert("çµŒè·¯åã¨é‡‘é¡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            routeMaster.push({name: name, price: price});
            localStorage.setItem(KEY_ROUTES, JSON.stringify(routeMaster));
            document.getElementById('newRouteName').value = "";
            document.getElementById('newRoutePrice').value = "";
            renderRouteMaster();
            updateSelectOptions();
        }
        function deleteRoute(idx) {
            routeMaster.splice(idx, 1);
            localStorage.setItem(KEY_ROUTES, JSON.stringify(routeMaster));
            renderRouteMaster();
            updateSelectOptions();
        }
        function renderRouteMaster() {
            const div = document.getElementById('routeList');
            let html = "";
            routeMaster.forEach((r, i) => {
                html += `<div class="route-list-item"><span>${r.name} (Â¥${r.price})</span><button class="btn-mini btn-del" onclick="deleteRoute(${i})">å‰Šé™¤</button></div>`;
            });
            div.innerHTML = html;
        }
        function updateSelectOptions() {
            // ä¸€æ‹¬è¨­å®šç”¨ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³æ›´æ–°
            const opts = `<option value="">é¸æŠãªã—</option>` + routeMaster.map((r, i) => `<option value="${i}">${r.name} (Â¥${r.price})</option>`).join('');
            document.getElementById('bulkOutward').innerHTML = "è¡Œã: " + opts;
            document.getElementById('bulkReturn').innerHTML = "å¸°ã‚Š: " + opts;
            // ãƒ†ãƒ¼ãƒ–ãƒ«å†…ã®ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã‚‚æ›´æ–°ãŒå¿…è¦ã ãŒã€å†æç”»(renderTable)ã§å¯¾å¿œ
            renderTable();
        }

        // --- ãƒ¡ã‚¤ãƒ³å‡¦ç† (æœˆå¤‰æ›´ãƒ»ãƒ‡ãƒ¼ã‚¿èª­è¾¼) ---
        function changeMonth() {
            const ym = document.getElementById('iptMonthPicker').value;
            if(!ym) return;
            
            const [y, m] = ym.split('-');
            document.getElementById('viewTargetMonth').innerText = `${y}å¹´ ${m}æœˆåº¦`;

            // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
            const key = KEY_DATA_PREFIX + ym;
            const json = localStorage.getItem(key);
            monthData = json ? JSON.parse(json) : {}; // ãƒ‡ãƒ¼ã‚¿ãªã‘ã‚Œã°ç©º

            renderTable();
        }

        // ãƒ†ãƒ¼ãƒ–ãƒ«æç”»
        function renderTable() {
            const ym = document.getElementById('iptMonthPicker').value;
            if(!ym) return;
            const [year, month] = ym.split('-').map(Number);
            const lastDay = new Date(year, month, 0).getDate();
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = "";

            const weeks = ["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"];
            
            // ãƒã‚¹ã‚¿ã®é¸æŠè‚¢HTMLä½œæˆ
            const options = `<option value="-1"></option>` + routeMaster.map((r, i) => `<option value="${i}">${r.name} (Â¥${r.price})</option>`).join('');

            let total = 0;
            let days = 0;

            for(let d=1; d<=lastDay; d++) {
                const dateObj = new Date(year, month-1, d);
                const weekIdx = dateObj.getDay();
                
                // ãƒ‡ãƒ¼ã‚¿å–å¾— (ãªã‘ã‚Œã°åˆæœŸå€¤)
                if(!monthData[d]) {
                    monthData[d] = { active: false, outIdx: -1, retIdx: -1, note: "" };
                }
                const data = monthData[d];

                // è¡Œä½œæˆ
                const tr = document.createElement('tr');
                if (weekIdx === 0 || isHoliday(month, d)) tr.classList.add('row-sun');
                else if (weekIdx === 6) tr.classList.add('row-sat');
                
                if (!data.active) tr.classList.add('row-off');

                // é‡‘é¡è¨ˆç®—
                let dayPrice = 0;
                if(data.active) {
                    days++;
                    if(data.outIdx >= 0) dayPrice += routeMaster[data.outIdx].price;
                    if(data.retIdx >= 0) dayPrice += routeMaster[data.retIdx].price;
                }
                total += dayPrice;

                tr.innerHTML = `
                    <td class="col-date">${d}</td>
                    <td class="col-week">${weeks[weekIdx]}</td>
                    <td class="col-check" onclick="toggleActive(${d})">${data.active ? 'å‡º' : 'ä¼‘'}</td>
                    <td class="col-route">
                        <div class="split-cell">
                            <div class="split-top">
                                <select class="route-select" onchange="changeRoute(${d}, 'out', this.value)">${options}</select>
                            </div>
                            <div class="split-bottom">
                                <select class="route-select" onchange="changeRoute(${d}, 'ret', this.value)">${options}</select>
                            </div>
                        </div>
                    </td>
                    <td class="col-price">${data.active ? dayPrice.toLocaleString() : '-'}</td>
                    <td class="col-note"><input type="text" class="ipt-note" value="${data.note}" onchange="changeNote(${d}, this.value)"></td>
                `;
                
                // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã®é¸æŠçŠ¶æ…‹ã‚’åæ˜ 
                const selects = tr.querySelectorAll('select');
                selects[0].value = data.outIdx;
                selects[1].value = data.retIdx;

                tbody.appendChild(tr);
            }

            document.getElementById('viewDays').innerText = days;
            document.getElementById('viewTotal').innerText = total.toLocaleString();
        }

        // ãƒ‡ãƒ¼ã‚¿æ“ä½œï¼†ä¿å­˜
        function saveCurrentData() {
            const ym = document.getElementById('iptMonthPicker').value;
            localStorage.setItem(KEY_DATA_PREFIX + ym, JSON.stringify(monthData));
            renderTable(); // å†æç”»ã—ã¦è¨ˆç®—æ›´æ–°
        }

        function toggleActive(day) {
            monthData[day].active = !monthData[day].active;
            saveCurrentData();
        }

        function changeRoute(day, type, value) {
            if(type === 'out') monthData[day].outIdx = parseInt(value);
            else monthData[day].retIdx = parseInt(value);
            
            // çµŒè·¯ã‚’é¸ã‚“ã ã‚‰è‡ªå‹•ã§ã€Œå‡ºå‹¤ã€ã«ã™ã‚‹
            if(value != -1) monthData[day].active = true;
            
            saveCurrentData();
        }

        function changeNote(day, value) {
            monthData[day].note = value;
            saveCurrentData(); // å†æç”»ã¯ä¸è¦ã ãŒä¿å­˜ã¯ã™ã‚‹
        }

        // ä¸€æ‹¬è¨­å®š
        function applyBulk() {
            const outIdx = parseInt(document.getElementById('bulkOutward').value);
            const retIdx = parseInt(document.getElementById('bulkReturn').value);
            
            if(isNaN(outIdx) && isNaN(retIdx)) return alert("çµŒè·¯ã‚’é¸æŠã—ã¦ãã ã•ã„");
            
            const ym = document.getElementById('iptMonthPicker').value;
            const [year, month] = ym.split('-').map(Number);
            const lastDay = new Date(year, month, 0).getDate();

            for(let d=1; d<=lastDay; d++) {
                const dateObj = new Date(year, month-1, d);
                const weekIdx = dateObj.getDay();
                // å¹³æ—¥ã®ã¿ (åœŸæ—¥ç¥ä»¥å¤–)
                if (weekIdx !== 0 && weekIdx !== 6 && !isHoliday(month, d)) {
                    monthData[d].active = true;
                    if(!isNaN(outIdx)) monthData[d].outIdx = outIdx;
                    if(!isNaN(retIdx)) monthData[d].retIdx = retIdx;
                }
            }
            saveCurrentData();
        }

        // ç°¡æ˜“ç¥æ—¥åˆ¤å®š (å¹´ã¾ãŸãã‚„æŒ¯æ›¿ä¼‘æ—¥ã¯éå¯¾å¿œ)
        function isHoliday(m, d) { return HOLIDAYS.includes(`${m}-${d}`); }

        document.getElementById('iptUserDept').addEventListener('input', updateHeader);
        document.getElementById('iptUserName').addEventListener('input', updateHeader);

    </script>
</body>
</html>