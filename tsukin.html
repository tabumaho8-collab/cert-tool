<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€šå‹¤è²»ç²¾ç®—æ›¸ (å¤šæ©Ÿèƒ½ç‰ˆ)</title>
    <style>
        /* --- ãƒ™ãƒ¼ã‚¹ã‚¹ã‚¿ã‚¤ãƒ« --- */
        body {
            font-family: var(--font-family, "Helvetica Neue", Arial, sans-serif);
            background-color: var(--bg-color, #f0f2f5);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* --- ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ --- */
        header {
            background-color: var(--header-bg, #2d3436);
            color: var(--header-text, #ffffff);
            width: 100%;
            height: 50px;
            padding: 0 20px;
            box-sizing: border-box;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1100;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-left h1 {
            margin: 0;
            font-size: 16px;
            font-weight: bold;
            color: inherit;
        }

        .header-left h1 span {
            font-weight: normal;
            color: inherit;
            font-size: 13px;
        }

        .back-btn-global {
            display: inline-flex;
            align-items: center;
            padding: 6px 15px;
            text-decoration: none;
            font-size: 12px;
            font-weight: bold;
            border-radius: var(--btn-radius);
            transition: 0.2s;
            margin-bottom: 15px;
        }

        .back-btn-global:hover {
            background-color: #80deea !important;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .theme-btn-header {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            cursor: pointer;
            color: inherit;
            font-weight: bold;
            transition: 0.2s;
        }

        .theme-btn-header:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .app-layout-wrapper {
            display: flex;
            flex-grow: 1;
            overflow: hidden;
            padding-top: 50px;
        }

        .sidebar {
            width: 320px;
            background: var(--sidebar-bg, #fff);
            padding: 20px;
            padding-bottom: 100px !important;
            border-right: 1px solid rgba(0, 0, 0, 0.1);
            height: 100%;
            overflow-y: auto;
            box-sizing: border-box;
            flex-shrink: 0;
            backdrop-filter: var(--backdrop-filter);
        }

        .sidebar h2 {
            font-size: 18px;
            /* â˜…è¦‹åˆ‡ã‚Œé˜²æ­¢ */
            margin-top: 0;
            border-bottom: 2px solid var(--accent-color, #6c5ce7);
            padding-bottom: 8px;
            color: var(--accent-color, #2d3436);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar h3 {
            font-size: 13px;
            background: #f1f3f5;
            padding: 8px 12px;
            margin-top: 25px;
            border-radius: 6px;
            color: #495057;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 6px;
            color: #555;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #dfe6e9;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #6c5ce7 0%, #a29bfe 100%) !important;
            color: white;
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 6px rgba(108, 92, 231, 0.2);
            transition: 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(108, 92, 231, 0.3);
        }

        .btn-danger {
            background: #ff7675;
            color: white;
            padding: 5px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 11px;
            transition: 0.2s;
        }

        .btn-danger:hover {
            background: #d63031;
        }

        .btn-print {
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%) !important;
            color: white;
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
            margin-top: 30px;
            box-shadow: 0 10px 20px rgba(46, 204, 113, 0.3);
            transition: 0.3s;
            display: block;
        }

        .btn-print:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(46, 204, 113, 0.4);
        }


        .route-row {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
        }

        .route-row input[type="text"] {
            flex: 2;
        }

        .route-row input[type="number"] {
            flex: 1;
        }

        /* ãƒãƒ³ã‚³è¨­å®šã‚¨ãƒªã‚¢ */
        .seal-setting-box {
            background: #fff8e1;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            border: 1px solid #ffe082;
        }

        .seal-title {
            font-size: 12px;
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }

        .seal-input {
            font-size: 11px;
            width: 100%;
        }

        .seal-preview-mini {
            height: 30px;
            margin-top: 5px;
            border: 1px solid #ddd;
            display: none;
        }

        .btn-clear {
            font-size: 10px;
            background: #999;
            color: white;
            border: none;
            padding: 2px 5px;
            cursor: pointer;
            margin-top: 2px;
            border-radius: 3px;
        }

        /* --- ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¨ãƒªã‚¢ï¼ˆãƒ¡ã‚¤ãƒ³ï¼‰ --- */
        .main-content {
            flex-grow: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        /* å¸³ç¥¨ãƒ‡ã‚¶ã‚¤ãƒ³ (A4) */
        .sheet {
            width: 210mm;
            min-height: 297mm;
            background: white;
            padding: 15mm 10mm;
            box-sizing: border-box;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            color: #333;
        }

        .sheet-title {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            /* ä½™ç™½ã‚’å¢—ã‚„ã™ */
            border-bottom: 3px double #333;
            padding-bottom: 5px;
            color: #000 !important;
            /* â˜…ç¢ºå®Ÿã«é»’ã§è¡¨ç¤º */
        }

        .sheet-info {
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }

        .info-left div {
            margin-bottom: 5px;
            font-size: 14px;
        }

        /* ãƒãƒ³ã‚³æ ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .hanko-box {
            display: flex;
            border: 1px solid #333;
        }

        .hanko-cell {
            width: 60px;
            height: 60px;
            border-right: 1px solid #333;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .hanko-cell:last-child {
            border-right: none;
        }

        .hanko-label {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 10px;
        }

        /* ãƒãƒ³ã‚³ç”»åƒè¡¨ç¤º */
        .seal-display {
            width: 45px;
            height: 45px;
            object-fit: contain;
            opacity: 0.85;
            display: none;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        /* æ°åæ¨ªã®å°é‘‘ */
        .name-seal-container {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            margin-left: 10px;
            position: relative;
            vertical-align: middle;
        }

        .seal-display-inline {
            width: 40px;
            height: 40px;
            object-fit: contain;
            opacity: 0.85;
            display: none;
        }

        .seal-dummy-text-inline {
            color: #ddd;
            font-size: 10px;
            border: 1px solid #eee;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .seal-dummy-text {
            color: #eee;
            font-size: 10px;
            z-index: 0;
        }

        /* 2åˆ—ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .cols-container {
            display: flex;
            gap: 10mm;
        }

        .col-half {
            flex: 1;
        }

        /* ãƒ†ãƒ¼ãƒ–ãƒ« */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            margin-bottom: 0;
        }

        th,
        td {
            border: 1px solid #000;
            padding: 4px 2px;
            text-align: center;
            height: 26px;
            box-sizing: border-box;
        }

        th {
            background: #eee;
            font-weight: bold;
        }

        select.route-select {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 11px;
            cursor: pointer;
            text-align: center;
            appearance: none;
            -webkit-appearance: none;
        }

        .print-text {
            display: none;
        }

        .weekend {
            background-color: #fce8e8;
            color: #d00;
        }

        .saturday {
            background-color: #e8f4fc;
            color: #00d;
        }

        .total-box {
            margin-top: 10px;
            text-align: right;
            font-size: 16px;
            font-weight: bold;
            padding: 5px;
            border-bottom: 2px solid #333;
        }

        /* --- ãƒ†ãƒ¼ãƒåˆ¥ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ --- */
        /* Kawaii Mode */
        body.theme-kawaii .sidebar {
            background: #fffcf0;
            border-right: 3px solid #ff9eb5;
        }

        body.theme-kawaii .sidebar h3 {
            background: #ffecf2;
            color: #d63384;
        }

        body.theme-kawaii .btn-primary {
            background: linear-gradient(135deg, #ff9eb5 0%, #ff7eb3 100%) !important;
            border-radius: 30px !important;
        }

        body.theme-kawaii .btn-print {
            background: linear-gradient(135deg, #ff6b81 0%, #ff4757 100%) !important;
            border-radius: 30px !important;
        }

        body.theme-kawaii .sheet {
            border-radius: 20px;
            border: 3px solid #ff9eb5;
        }

        /* Dark Mode */
        body.theme-dark {
            background-color: #050508;
            color: #e0f7fa;
        }

        body.theme-dark .sidebar {
            background: rgba(15, 23, 42, 0.95);
            border-right: 1px solid #00e5ff;
            box-shadow: 5px 0 25px rgba(0, 229, 255, 0.2);
        }

        body.theme-dark .sidebar h2 {
            color: #00e5ff;
            border-color: #00e5ff;
            text-shadow: 0 0 10px #00e5ff;
        }

        body.theme-dark .sidebar h3 {
            background: rgba(0, 229, 255, 0.1);
            color: #00e5ff;
        }

        body.theme-dark .form-group label {
            color: #80deea;
        }

        body.theme-dark .form-group input,
        body.theme-dark .form-group select {
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            border-color: #00e5ff;
        }

        body.theme-dark .btn-primary {
            background: rgba(0, 229, 255, 0.2) !important;
            color: #00e5ff !important;
            border: 1px solid #00e5ff !important;
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.3);
        }

        body.theme-dark .btn-primary:hover {
            background: #00e5ff !important;
            color: #000 !important;
        }

        body.theme-dark .btn-print {
            background: #00e5ff !important;
            color: #000 !important;
            box-shadow: 0 0 20px #00e5ff !important;
        }

        body.theme-dark .sheet {
            background: #fff;
            color: #333;
        }

        /* å¸³ç¥¨ã¯ç™½èƒŒæ™¯ç¶­æŒï¼ˆå°åˆ·ç”¨ï¼‰ */

        /* --- å°åˆ·è¨­å®š --- */
        @media print {
            body {
                background: none;
                display: block;
                margin: 0;
            }

            .sidebar {
                display: none !important;
            }

            .main-content {
                margin: 0 !important;
                padding: 0 !important;
                width: 100% !important;
            }

            .sheet {
                box-shadow: none !important;
                width: 100% !important;
                height: auto !important;
                margin: 0 !important;
                padding: 15mm 10mm !important;
            }

            select.route-select {
                display: none !important;
            }

            .print-text {
                display: block !important;
            }

            .seal-dummy-text {
                display: none !important;
            }

            @page {
                size: A4 portrait;
                margin: 0;
            }
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 1100px) {
            body {
                flex-direction: column;
                align-items: center;
            }

            .sidebar {
                position: static;
                width: 100%;
                height: auto;
                padding-bottom: 30px !important;
            }

            .main-content {
                margin-left: 0;
                display: flex;
                justify-content: center;
            }

            .sheet {
                width: 95vw;
                height: auto;
                padding: 10mm 5mm;
            }
        }
    </style>
    <link rel="stylesheet" href="theme.css">
</head>

<body>

    <!-- â–¼ ãƒ˜ãƒƒãƒ€ãƒ¼ â–¼ -->
    <header id="global-header">
        <div class="header-left">
            <h1>ç¤¾å†…ãƒ„ãƒ¼ãƒ« <span>/ é€šå‹¤è²»ç²¾ç®—æ›¸</span></h1>
        </div>
        <div class="header-right">
            <button onclick="toggleTheme()" id="themeBtn" class="theme-btn-header">ğŸ¨ ãƒ†ãƒ¼ãƒå¤‰æ›´</button>
        </div>
    </header>

    <div class="app-layout-wrapper">
        <!-- â–¼ ã‚µã‚¤ãƒ‰ãƒãƒ¼è¨­å®šã‚¨ãƒªã‚¢ â–¼ -->
        <aside class="sidebar">
            <a href="index.html" class="back-btn back-btn-global">â¬… ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a>
            <h2 class="sidebar-title" style="margin-top: 5px; color: var(--accent-color);">é€šå‹¤è²»ç²¾ç®—æ›¸</h2>
            <p style="font-size: 11px; color: var(--text-sub); margin-top: -10px; margin-bottom: 20px;">å¤šæ©Ÿèƒ½ãƒãƒƒã‚¯ã‚ªãƒ•ã‚£ã‚¹ãƒ»ãƒ„ãƒ¼ãƒ«
            </p>

            <!-- ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç† -->
            <div style="background:#eef; padding:10px; border-radius:4px; margin-bottom:15px;">
                <label style="font-weight:bold; font-size:12px;">ğŸ‘¤ ãƒ¡ãƒ³ãƒãƒ¼é¸æŠ</label>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <select id="userSelect" onchange="loadUser()" style="flex:1;"></select>
                    <button onclick="addUser()" style="width:30px;">ï¼‹</button>
                    <button onclick="deleteUser()"
                        style="width:30px; background:#d9534f; color:white; border:none;">ğŸ—‘ï¸</button>
                </div>
            </div>

            <div class="form-group"><label>å¯¾è±¡å¹´æœˆ</label><input type="month" id="targetMonth" onchange="updateTable()">
            </div>
            <div class="form-group"><label>æ‰€å±</label><input type="text" id="iptDept" placeholder="å–¶æ¥­éƒ¨"
                    oninput="saveCurrentData()"></div>
            <div class="form-group"><label>æ°å</label><input type="text" id="iptName" placeholder="æ°å"
                    oninput="saveCurrentData()"></div>

            <!-- ãƒãƒ³ã‚³è¨­å®šã‚¨ãƒªã‚¢ (3ã¤) -->
            <h3>ğŸ’® é›»å­å°é‘‘ã®è¨­å®š</h3>

            <div class="seal-setting-box">
                <span class="seal-title">æ‰¿èªå° (å·¦æ )</span>
                <input type="file" accept="image/*" class="seal-input" onchange="handleFileSelect(this, 'sealShonin')">
                <img id="prev_sealShonin" class="seal-preview-mini">
                <button class="btn-clear" onclick="clearSeal('sealShonin')">å‰Šé™¤</button>
            </div>

            <div class="seal-setting-box">
                <span class="seal-title">ç¢ºèªå° (ä¸­æ )</span>
                <input type="file" accept="image/*" class="seal-input" onchange="handleFileSelect(this, 'sealKakunin')">
                <img id="prev_sealKakunin" class="seal-preview-mini">
                <button class="btn-clear" onclick="clearSeal('sealKakunin')">å‰Šé™¤</button>
            </div>

            <div class="seal-setting-box">
                <span class="seal-title">æ‹…å½“å° (å³æ )</span>
                <input type="file" accept="image/*" class="seal-input" onchange="handleFileSelect(this, 'sealTanto')">
                <img id="prev_sealTanto" class="seal-preview-mini">
                <button class="btn-clear" onclick="clearSeal('sealTanto')">å‰Šé™¤</button>
                <div style="font-size:10px; color:#666; margin-top:5px;">
                    â€»ç™»éŒ²ãŒãªã„å ´åˆã€å…±é€šè¨­å®šã®ãƒãƒ³ã‚³ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
                </div>
            </div>

            <hr>
            <h3>ğŸš— çµŒè·¯ãƒã‚¹ã‚¿</h3>
            <div id="routeConfig"></div>
            <button class="btn-primary" onclick="addRouteInput()"
                style="margin-top:5px; background:#6c757d; font-size:12px;">ï¼‹ çµŒè·¯æ¬„ã‚’è¿½åŠ </button>

            <hr>
            <h3>âš¡ ä¸€æ‹¬å…¥åŠ› (å¹³æ—¥)</h3>
            <div class="form-group"><label>è¡Œã</label><select id="batchGo"></select></div>
            <div class="form-group"><label>å¸°ã‚Š</label><select id="batchBack"></select></div>
            <button class="btn-primary" onclick="applyBatch()">å¹³æ—¥ã«ä¸€æ‹¬ã‚»ãƒƒãƒˆ</button>

            <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ å°åˆ·ã™ã‚‹</button>
        </aside>

        <!-- â–¼ ãƒ¡ã‚¤ãƒ³å¸³ç¥¨ã‚¨ãƒªã‚¢ â–¼ -->
        <div class="main-content">
            <div class="sheet">
                <div class="sheet-title">é€šå‹¤è²»ç²¾ç®—æ›¸</div>

                <div class="sheet-info">
                    <div class="info-left">
                        <div>å¯¾è±¡æœˆï¼š <span id="viewMonth"></span></div>
                        <div>æ‰€ã€€å±ï¼š <span id="viewDept"></span></div>
                        <div style="display: flex; align-items: center;">
                            æ°ã€€åï¼š <span id="viewName" style="font-size:18px; font-weight:bold;"></span>
                            <div class="name-seal-container">
                                <img id="view_sealTanto" class="seal-display-inline">
                                <span class="seal-dummy-text-inline">(å°)</span>
                            </div>
                        </div>
                    </div>
                    <div class="hanko-box">
                        <!-- æ‰¿èªå° -->
                        <div class="hanko-cell">
                            <span class="hanko-label">æ‰¿èª</span>
                            <img id="view_sealShonin" class="seal-display">
                            <span class="seal-dummy-text">(å°)</span>
                        </div>
                        <!-- ç¢ºèªå° -->
                        <div class="hanko-cell">
                            <span class="hanko-label">ç¢ºèª</span>
                            <img id="view_sealKakunin" class="seal-display">
                            <span class="seal-dummy-text">(å°)</span>
                        </div>
                    </div>
                </div>

                <div class="cols-container">
                    <div class="col-half">
                        <table id="tableLeft">
                            <thead>
                                <tr>
                                    <th style="width:30px;">æ—¥</th>
                                    <th style="width:30px;">æ›œ</th>
                                    <th>è¡Œã</th>
                                    <th>å¸°ã‚Š</th>
                                    <th style="width:50px;">é‡‘é¡</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="col-half">
                        <table id="tableRight">
                            <thead>
                                <tr>
                                    <th style="width:30px;">æ—¥</th>
                                    <th style="width:30px;">æ›œ</th>
                                    <th>è¡Œã</th>
                                    <th>å¸°ã‚Š</th>
                                    <th style="width:50px;">é‡‘é¡</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="total-box">åˆè¨ˆé‡‘é¡ï¼š Â¥ <span id="grandTotal">0</span></div>

                <div style="margin-top:10px; font-size:12px;">
                    å‚™è€ƒï¼š<br>
                    <textarea id="iptNote"
                        style="width:100%; border:none; resize:none; background:#f9f9f9; height:50px;"
                        placeholder="ç‰¹è¨˜äº‹é …ãŒã‚ã‚Œã°å…¥åŠ›" oninput="saveCurrentData()"></textarea>
                    <div id="viewNote" class="print-text" style="white-space:pre-wrap;"></div>
                </div>
            </div>
        </div>

        <script>
            const KEY_USERS = "my_tool_tsukin_users";
            const KEY_COMPANY = "my_tool_company_info";
            const THEMES = ['', 'theme-kawaii', 'theme-dark'];

            let currentUserIndex = 0;
            let users = [];
            let routes = [
                { name: "è‡ªå®…â‡”ä¼šç¤¾ (ä¸‹é“)", cost: 420 },
                { name: "è‡ªå®…â‡”ä¼šç¤¾ (é«˜é€Ÿ)", cost: 1200 },
                { name: "é›»è»Šé€šå‹¤", cost: 560 }
            ];
            const defaultRoutes = JSON.parse(JSON.stringify(routes));

            window.addEventListener('load', () => {
                // ãƒ†ãƒ¼ãƒå¾©å…ƒ
                const savedTheme = localStorage.getItem('my_tool_theme');
                if (savedTheme && THEMES.includes(savedTheme)) {
                    document.body.className = savedTheme;
                }
                updateBtnText();

                const d = new Date();
                const ym = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                document.getElementById('targetMonth').value = ym;
                loadUsers();
                renderRouteInputs();
                updateTable();
            });

            function toggleTheme() {
                const body = document.body;
                let currentClass = "";
                if (body.classList.contains('theme-kawaii')) currentClass = 'theme-kawaii';
                else if (body.classList.contains('theme-dark')) currentClass = 'theme-dark';

                const currentIndex = THEMES.indexOf(currentClass);
                const nextIndex = (currentIndex + 1) % THEMES.length;
                const nextClass = THEMES[nextIndex];

                body.className = nextClass;
                localStorage.setItem('my_tool_theme', nextClass);
                updateBtnText();
            }

            function updateBtnText() {
                const btn = document.getElementById('themeBtn');
                const body = document.body;
                if (body.classList.contains('theme-kawaii')) {
                    btn.innerText = "ğŸŒ¸ ãƒ¢ãƒ¼ãƒ‰ï¼šKawaii";
                } else if (body.classList.contains('theme-dark')) {
                    btn.innerText = "âš¡ ãƒ¢ãƒ¼ãƒ‰ï¼šNeon";
                } else {
                    btn.innerText = "âœ¨ ãƒ¢ãƒ¼ãƒ‰ï¼šSimple";
                }
            }

            // --- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç† ---
            function loadUsers() {
                const json = localStorage.getItem(KEY_USERS);
                if (json) { users = JSON.parse(json); }
                else { users = [{ name: "è‡ªåˆ†ç”¨", dept: "", routes: defaultRoutes, data: {}, seals: {} }]; }
                renderUserSelect();
                loadUser();
            }

            function renderUserSelect() {
                const sel = document.getElementById('userSelect');
                sel.innerHTML = "";
                users.forEach((u, idx) => {
                    const opt = document.createElement('option');
                    opt.value = idx;
                    opt.text = u.name;
                    sel.appendChild(opt);
                });
                sel.value = currentUserIndex;
            }

            function addUser() {
                const name = prompt("æ–°ã—ã„ãƒ¡ãƒ³ãƒãƒ¼å:");
                if (name) {
                    users.push({ name: name, dept: "", routes: defaultRoutes, data: {}, seals: {} });
                    saveUsers();
                    currentUserIndex = users.length - 1;
                    renderUserSelect();
                    loadUser();
                }
            }

            function deleteUser() {
                if (users.length <= 1) return alert("å‰Šé™¤ã§ãã¾ã›ã‚“");
                if (confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                    users.splice(currentUserIndex, 1);
                    currentUserIndex = 0;
                    saveUsers();
                    renderUserSelect();
                    loadUser();
                }
            }

            function saveUsers() { localStorage.setItem(KEY_USERS, JSON.stringify(users)); }

            function loadUser() {
                currentUserIndex = document.getElementById('userSelect').value;
                const u = users[currentUserIndex];
                document.getElementById('iptName').value = u.name;
                document.getElementById('iptDept').value = u.dept || "";
                document.getElementById('iptNote').value = u.note || "";

                if (u.routes) routes = u.routes;

                // ãƒãƒ³ã‚³åæ˜ 
                if (!u.seals) u.seals = {};
                applySeal('sealShonin', u.seals.shonin);
                applySeal('sealKakunin', u.seals.kakunin);
                applySeal('sealTanto', u.seals.tanto);

                renderRouteInputs();
                updateTable();
            }

            function saveCurrentData() {
                const u = users[currentUserIndex];
                u.name = document.getElementById('iptName').value;
                u.dept = document.getElementById('iptDept').value;
                u.note = document.getElementById('iptNote').value;
                u.routes = getRoutesFromInput();

                const month = document.getElementById('targetMonth').value;
                const dailyData = {};
                document.querySelectorAll('tr[data-day]').forEach(row => {
                    dailyData[row.getAttribute('data-day')] = {
                        go: row.querySelector('.go-select').value,
                        back: row.querySelector('.back-select').value
                    };
                });
                if (!u.data) u.data = {};
                u.data[month] = dailyData;

                saveUsers();

                document.getElementById('viewName').innerText = u.name;
                document.getElementById('viewDept').innerText = u.dept;
                document.getElementById('viewNote').innerText = u.note;
                calculateTotal();
            }

            // --- ãƒãƒ³ã‚³å‡¦ç† ---
            function handleFileSelect(input, type) {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const dataUrl = e.target.result;
                        const u = users[currentUserIndex];
                        if (!u.seals) u.seals = {};

                        if (type === 'sealShonin') u.seals.shonin = dataUrl;
                        if (type === 'sealKakunin') u.seals.kakunin = dataUrl;
                        if (type === 'sealTanto') u.seals.tanto = dataUrl;

                        saveUsers();
                        loadUser(); // å†æç”»
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            }

            function clearSeal(type) {
                const u = users[currentUserIndex];
                if (!u.seals) return;
                if (type === 'sealShonin') u.seals.shonin = null;
                if (type === 'sealKakunin') u.seals.kakunin = null;
                if (type === 'sealTanto') u.seals.tanto = null;

                // inputã‚¿ã‚°ã‚‚ã‚¯ãƒªã‚¢
                const inputs = document.querySelectorAll('.seal-input');
                inputs.forEach(i => i.value = "");

                saveUsers();
                loadUser();
            }

            function applySeal(type, dataUrl) {
                const isTanto = (type === 'sealTanto');
                const imgView = document.getElementById('view_' + type);
                const dummySpan = isTanto ? imgView.nextElementSibling : imgView.nextElementSibling;
                // tantoã®å ´åˆã¯ seal-dummy-text-inline

                const imgPrev = document.getElementById('prev_' + type);

                let src = dataUrl;

                // æ‹…å½“å°ã®ã¿ã€å€‹åˆ¥è¨­å®šãŒãªã‘ã‚Œã°å…±é€šè¨­å®š(index.html)ã‚’è¦‹ã‚‹
                if (type === 'sealTanto' && !src) {
                    const companyJson = localStorage.getItem(KEY_COMPANY);
                    if (companyJson) {
                        const co = JSON.parse(companyJson);
                        src = co.sealData || co.seal || co.stamp;
                    }
                }

                if (src && src.length > 50) {
                    imgView.src = src;
                    imgView.style.display = "block";
                    // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ¬„
                    imgPrev.src = src;
                    imgPrev.style.display = "block";
                    // ãƒ€ãƒŸãƒ¼æ–‡å­—ã‚’æ¶ˆã™
                    if (imgView.nextElementSibling) imgView.nextElementSibling.style.display = "none";
                } else {
                    imgView.style.display = "none";
                    imgPrev.style.display = "none";
                    // ãƒ€ãƒŸãƒ¼æ–‡å­—ã‚’å‡ºã™
                    if (imgView.nextElementSibling) imgView.nextElementSibling.style.display = isTanto ? "flex" : "block";
                }
            }

            // --- ä»¥ä¸‹ã€è¨ˆç®—ãƒ»æç”»ãƒ­ã‚¸ãƒƒã‚¯ ---
            function renderRouteInputs() {
                const container = document.getElementById('routeConfig');
                container.innerHTML = "";
                routes.forEach((r, i) => {
                    container.innerHTML += `<div class="route-row"><input type="text" value="${r.name}" class="r-name" onchange="saveCurrentData();updateBatchSelect()"><input type="number" value="${r.cost}" class="r-cost" onchange="saveCurrentData();updateTable()"></div>`;
                });
                updateBatchSelect();
            }
            function addRouteInput() { routes.push({ name: "", cost: 0 }); renderRouteInputs(); saveCurrentData(); }
            function getRoutesFromInput() {
                const newRoutes = [];
                document.querySelectorAll('#routeConfig .route-row').forEach(row => {
                    const name = row.querySelector('.r-name').value;
                    const cost = parseInt(row.querySelector('.r-cost').value) || 0;
                    if (name) newRoutes.push({ name, cost });
                });
                return newRoutes;
            }
            function updateBatchSelect() {
                const opts = `<option value="">(ãªã—)</option>` + routes.map((r, i) => `<option value="${i}">${r.name} (Â¥${r.cost})</option>`).join('');
                document.getElementById('batchGo').innerHTML = opts;
                document.getElementById('batchBack').innerHTML = opts;
                updateTable(false);
            }
            function updateTable(load = true) {
                const ym = document.getElementById('targetMonth').value;
                if (!ym) return;
                const [year, month] = ym.split('-').map(Number);
                document.getElementById('viewMonth').innerText = `${year}å¹´ ${month}æœˆåº¦`;
                document.getElementById('viewName').innerText = document.getElementById('iptName').value;
                document.getElementById('viewDept').innerText = document.getElementById('iptDept').value;

                const u = users[currentUserIndex];
                const savedData = (u.data && u.data[ym]) ? u.data[ym] : {};
                const lastDay = new Date(year, month, 0).getDate();
                const tbLeft = document.querySelector('#tableLeft tbody');
                const tbRight = document.querySelector('#tableRight tbody');
                tbLeft.innerHTML = ""; tbRight.innerHTML = "";

                const routeOpts = `<option value="">-</option>` + routes.map((r, i) => `<option value="${i}">${r.name}</option>`).join('');

                for (let d = 1; d <= lastDay; d++) {
                    const dateObj = new Date(year, month - 1, d);
                    const dow = dateObj.getDay();
                    let cls = ""; if (dow === 0) cls = "weekend"; if (dow === 6) cls = "saturday";
                    const saved = savedData[d] || { go: "", back: "" };

                    const tr = document.createElement('tr');
                    tr.setAttribute('data-day', d); tr.setAttribute('data-dow', dow);
                    if (cls) tr.className = cls;
                    tr.innerHTML = `<td>${d}</td><td>${["æ—¥", "æœˆ", "ç«", "æ°´", "æœ¨", "é‡‘", "åœŸ"][dow]}</td>
                <td><select class="route-select go-select" onchange="calcRow(this)">${routeOpts}</select><span class="print-text go-text"></span></td>
                <td><select class="route-select back-select" onchange="calcRow(this)">${routeOpts}</select><span class="print-text back-text"></span></td>
                <td class="row-total">0</td>`;

                    tr.querySelector('.go-select').value = saved.go;
                    tr.querySelector('.back-select').value = saved.back;

                    if (d <= 15) tbLeft.appendChild(tr); else tbRight.appendChild(tr);
                    calcRow(tr.querySelector('.go-select'));
                }
                calculateTotal();
            }
            function calcRow(el) {
                const tr = el.closest('tr');
                const g = tr.querySelector('.go-select').value;
                const b = tr.querySelector('.back-select').value;
                let c = 0, gt = "-", bt = "-";
                if (g !== "") { const r = routes[g]; if (r) { c += r.cost; gt = r.name; } }
                if (b !== "") { const r = routes[b]; if (r) { c += r.cost; bt = r.name; } }
                tr.querySelector('.row-total').innerText = c > 0 ? c.toLocaleString() : "-";
                tr.querySelector('.go-text').innerText = gt;
                tr.querySelector('.back-text').innerText = bt;
                saveCurrentData();
            }
            function calculateTotal() {
                let t = 0; document.querySelectorAll('.row-total').forEach(td => { const v = parseInt(td.innerText.replace(/,/g, '')); if (!isNaN(v)) t += v; });
                document.getElementById('grandTotal').innerText = t.toLocaleString();
            }
            function applyBatch() {
                const g = document.getElementById('batchGo').value; const b = document.getElementById('batchBack').value;
                document.querySelectorAll('tr[data-dow]').forEach(tr => {
                    const d = parseInt(tr.getAttribute('data-dow'));
                    if (d !== 0 && d !== 6) { tr.querySelector('.go-select').value = g; tr.querySelector('.back-select').value = b; calcRow(tr.querySelector('.go-select')); }
                });
                saveCurrentData();
            }
        </script>
    </div>
    <script src="theme.js"></script>
</body>

</html>