<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>年間勤怠・有給計画</title>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; margin: 0; padding: 20px; display: flex; gap: 20px; height: 100vh; box-sizing: border-box; }
        
        /* 左サイドバー（集計エリア） */
        .sidebar { width: 300px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 20px; overflow-y: auto; flex-shrink: 0; }
        .back-btn { display: inline-block; background-color: #6c757d; color: white; padding: 5px 10px; text-decoration: none; border-radius: 4px; font-size: 12px; margin-bottom: 10px; width: fit-content; }
        
        h2 { font-size: 18px; margin: 0 0 10px 0; border-bottom: 2px solid #28a745; padding-bottom: 5px; color: #333; }
        
        /* 年切り替え */
        .year-selector { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 20px; font-weight: bold; }
        .year-btn { cursor: pointer; background: none; border: 1px solid #ccc; border-radius: 4px; padding: 2px 10px; }

        /* カード共通スタイル */
        .stat-card { background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; padding: 15px; }
        .stat-title { font-size: 12px; font-weight: bold; color: #555; margin-bottom: 5px; border-left: 4px solid #28a745; padding-left: 8px; }
        .stat-value { font-size: 24px; font-weight: bold; color: #333; }
        .stat-sub { font-size: 12px; color: #666; }
        
        /* アラート表示用 */
        .alert-msg { font-size: 12px; color: #dc3545; font-weight: bold; margin-top: 5px; display: none; align-items: center; gap: 5px; }
        .stat-card.warning { border-color: #dc3545; background-color: #fff8f8; }
        .stat-card.warning .stat-title { border-left-color: #dc3545; }
        .stat-card.success { border-color: #28a745; background-color: #f0fff4; }
        
        /* 入力フォーム */
        .input-group { margin-bottom: 5px; }
        .input-group label { display: block; font-size: 11px; margin-bottom: 2px; }
        .input-group input { width: 60px; padding: 5px; border-radius: 4px; border: 1px solid #ccc; }

        /* 凡例 */
        .legend { display: flex; gap: 10px; font-size: 12px; margin-top: auto; }
        .legend-item { display: flex; align-items: center; gap: 5px; }
        .box { width: 12px; height: 12px; border-radius: 2px; }
        .box-work { border: 1px solid #ddd; background: white; }
        .box-holiday { background-color: #ffcccc; }
        .box-paid { background-color: #cce5ff; }

        /* 右メイン（カレンダーエリア） */
        .main-calendar { flex: 1; overflow-y: auto; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        /* グリッド設定：幅を少し広げてゆったり配置 */
        .calendar-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
        
        /* 月カレンダー */
        .month-card { border: 1px solid #eee; border-radius: 4px; overflow: hidden; display: flex; flex-direction: column; }
        .month-header { background: #333; color: white; text-align: center; padding: 8px; font-weight: bold; font-size: 16px; }
        .week-header { display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; font-size: 12px; background: #f9f9f9; padding: 5px 0; border-bottom: 1px solid #eee; font-weight:bold; }
        .day-grid { display: grid; grid-template-columns: repeat(7, 1fr); flex-grow: 1; }
        
        /* ▼▼▼ ここを大きくしました ▼▼▼ */
        .day-cell { 
            height: 60px; /* 高さ倍増 (30px -> 60px) */
            border-bottom: 1px solid #f0f0f0; 
            border-right: 1px solid #f0f0f0; 
            font-size: 16px; /* 文字サイズUP (12px -> 16px) */
            font-weight: 500;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            cursor: pointer; 
            user-select: none;
            transition: background 0.1s;
        }
        .day-cell:hover { background-color: #f5f5f5; }
        /* ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲ */

        .day-cell:nth-child(7n), .day-cell:nth-child(7n+1) { color: #d9534f; } /* 土日は赤文字 */
        
        /* 状態ごとの色 */
        .status-holiday { background-color: #ffcccc; color: #a00 !important; font-weight: bold; }
        .status-paid { background-color: #cce5ff; color: #0056b3 !important; font-weight: bold; }
        .status-work { background-color: white; }

        /* 3連休以上の強調線 */
        .consecutive-3 { border-bottom: 4px solid #ffa500; }
        .consecutive-5 { border-bottom: 4px solid #dc3545; }

    </style>
</head>
<body>
    <script src="auth.js"></script>
    <script src="settings.js"></script>
    <script>
        if (typeof checkAuth === 'function') checkAuth(); 
        
        const KEY_KINTAI_DATA = "my_tool_kintai_data";
        const KEY_KINTAI_STOCK = "my_tool_kintai_stock";
    </script>

    <!-- サイドバー -->
    <div class="sidebar">
        <a href="index.html" class="back-btn">⬅ メニュー</a>
        <h2>勤怠・有給管理</h2>
        
        <div class="year-selector">
            <button class="year-btn" onclick="changeYear(-1)">◀</button>
            <span id="displayYear">2025</span> 年
            <button class="year-btn" onclick="changeYear(1)">▶</button>
        </div>

        <!-- 有給残日数 -->
        <div class="stat-card">
            <div class="stat-title">有給休暇 残数管理</div>
            <div class="input-group">
                <label>今年度の有給総数</label>
                <input type="number" id="iptStock" value="20" onchange="updateStats()"> 日
            </div>
            <div style="margin-top:5px; font-size:13px;">
                使用数: <span id="valUsed" style="font-weight:bold;">0</span> 日<br>
                残り: <span id="valRemain" style="color:#28a745; font-weight:bold;">20</span> 日
            </div>
        </div>

        <!-- 年間休日 -->
        <div class="stat-card" id="cardHoliday">
            <div class="stat-title">年間休日目標 (110日)</div>
            <div class="stat-value"><span id="valTotalHoliday">0</span> <span style="font-size:14px; font-weight:normal;">日</span></div>
            <div class="stat-sub">公休 + 有給</div>
            <div class="alert-msg" id="alertHoliday">⚠️ あと <span id="remHoliday">0</span> 日不足</div>
        </div>

        <!-- 連休チェック -->
        <div class="stat-card" id="cardRenkyu3">
            <div class="stat-title">3連休以上 (目標:3回)</div>
            <div class="stat-value"><span id="valRenkyu3">0</span> <span style="font-size:14px; font-weight:normal;">回</span></div>
            <div class="alert-msg" id="alertRenkyu3">⚠️ あと <span id="remRenkyu3">0</span> 回不足</div>
        </div>
        
        <div class="stat-card" id="cardRenkyu5">
            <div class="stat-title">5連休以上 (目標:1回)</div>
            <div class="stat-value"><span id="valRenkyu5">0</span> <span style="font-size:14px; font-weight:normal;">回</span></div>
            <div class="alert-msg" id="alertRenkyu5">⚠️ まだ取得できていません</div>
        </div>

        <!-- 半期ごとの有給 -->
        <div class="stat-card" id="cardHanki">
            <div class="stat-title">半期ごとの有給 (目標:各2回)</div>
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <div>上期(1-6): <span id="valFirstHalf" style="font-weight:bold;">0</span></div>
                <div>下期(7-12): <span id="valSecondHalf" style="font-weight:bold;">0</span></div>
            </div>
            <div class="alert-msg" id="alertHanki">⚠️ <span id="txtHanki">上期・下期ともに不足</span></div>
        </div>

        <div class="legend">
            <div class="legend-item"><div class="box box-work"></div>出勤</div>
            <div class="legend-item"><div class="box box-holiday"></div>公休</div>
            <div class="legend-item"><div class="box box-paid"></div>有給</div>
        </div>
    </div>

    <!-- メインカレンダー -->
    <div class="main-calendar">
        <div id="calendarGrid" class="calendar-grid"></div>
    </div>

    <script>
        let currentYear = 2025;
        let kintaiData = {}; 

        window.onload = function() {
            const savedData = localStorage.getItem(KEY_KINTAI_DATA);
            if (savedData) kintaiData = JSON.parse(savedData);
            
            const savedStock = localStorage.getItem(KEY_KINTAI_STOCK);
            if (savedStock) document.getElementById('iptStock').value = savedStock;

            renderCalendar();
            updateStats();
        };

        function changeYear(offset) {
            currentYear += offset;
            document.getElementById('displayYear').innerText = currentYear;
            renderCalendar();
            updateStats();
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            grid.innerHTML = "";
            const weeks = ["日","月","火","水","木","金","土"];

            for (let m = 1; m <= 12; m++) {
                const monthDiv = document.createElement('div');
                monthDiv.className = "month-card";
                
                let html = `<div class="month-header">${m}月</div>`;
                html += `<div class="week-header">` + weeks.map(w => `<div>${w}</div>`).join('') + `</div>`;
                html += `<div class="day-grid">`;

                const firstDay = new Date(currentYear, m-1, 1).getDay();
                const lastDate = new Date(currentYear, m, 0).getDate();
                for(let i=0; i<firstDay; i++) {
                    html += `<div class="day-cell"></div>`;
                }

                for(let d=1; d<=lastDate; d++) {
                    const key = `${currentYear}-${m}-${d}`;
                    let status = "work";
                    const w = new Date(currentYear, m-1, d).getDay();
                    if (w === 0 || w === 6) status = "holiday";
                    
                    if (kintaiData[key]) status = kintaiData[key];

                    const className = `status-${status}`;
                    html += `<div class="day-cell ${className}" id="cell-${key}" onclick="toggleStatus('${key}')">${d}</div>`;
                }
                html += `</div>`;
                monthDiv.innerHTML = html;
                grid.appendChild(monthDiv);
            }
        }

        function toggleStatus(key) {
            const current = kintaiData[key] || getDefaultStatus(key);
            let next = "work";
            if (current === "work") next = "holiday";
            else if (current === "holiday") next = "paid";
            else if (current === "paid") next = "work";

            kintaiData[key] = next;
            localStorage.setItem(KEY_KINTAI_DATA, JSON.stringify(kintaiData));
            
            const cell = document.getElementById(`cell-${key}`);
            cell.className = `day-cell status-${next}`;
            updateStats();
        }

        function getDefaultStatus(key) {
            const parts = key.split('-');
            const date = new Date(parts[0], parts[1]-1, parts[2]);
            const w = date.getDay();
            return (w === 0 || w === 6) ? "holiday" : "work";
        }

        function updateStats() {
            let totalHoliday = 0;
            let totalPaid = 0;
            let firstHalfPaid = 0;
            let secondHalfPaid = 0;
            
            // 日付データをリスト化して走査
            const dayStatusList = [];
            const jan1 = new Date(currentYear, 0, 1);
            const dec31 = new Date(currentYear, 11, 31);
            
            for (let d = new Date(jan1); d <= dec31; d.setDate(d.getDate() + 1)) {
                const y = d.getFullYear();
                const m = d.getMonth() + 1;
                const day = d.getDate();
                const key = `${y}-${m}-${day}`;
                
                const status = kintaiData[key] || getDefaultStatus(key);
                dayStatusList.push({ key, status, m });

                if (status === "holiday") totalHoliday++;
                if (status === "paid") {
                    totalPaid++;
                    if (m <= 6) firstHalfPaid++; else secondHalfPaid++;
                }
            }

            // 連休計算
            let count3 = 0;
            let count5 = 0;
            let currentStreak = 0;

            dayStatusList.forEach((item, index) => {
                const isOff = (item.status === "holiday" || item.status === "paid");
                if (isOff) {
                    currentStreak++;
                } else {
                    if (currentStreak >= 5) count5++;
                    if (currentStreak >= 3) count3++;
                    currentStreak = 0;
                }
            });
            if (currentStreak >= 5) count5++;
            if (currentStreak >= 3) count3++;

            const totalOff = totalHoliday + totalPaid;
            const stock = parseInt(document.getElementById('iptStock').value) || 20;
            localStorage.setItem(KEY_KINTAI_STOCK, stock);
            document.getElementById('valUsed').innerText = totalPaid;
            document.getElementById('valRemain').innerText = stock - totalPaid;

            // アラート更新
            document.getElementById('valTotalHoliday').innerText = totalOff;
            checkAlert('cardHoliday', 'alertHoliday', totalOff < 110);
            if(totalOff < 110) document.getElementById('remHoliday').innerText = (110 - totalOff);

            document.getElementById('valRenkyu3').innerText = count3;
            checkAlert('cardRenkyu3', 'alertRenkyu3', count3 < 3);
            if(count3 < 3) document.getElementById('remRenkyu3').innerText = (3 - count3);

            document.getElementById('valRenkyu5').innerText = count5;
            checkAlert('cardRenkyu5', 'alertRenkyu5', count5 < 1);

            document.getElementById('valFirstHalf').innerText = firstHalfPaid;
            document.getElementById('valSecondHalf').innerText = secondHalfPaid;
            
            let hankiMsg = "";
            let isHankiAlert = false;
            if (firstHalfPaid < 2 && secondHalfPaid < 2) {
                hankiMsg = "上期・下期ともに不足"; isHankiAlert = true;
            } else if (firstHalfPaid < 2) {
                hankiMsg = "上期があと " + (2 - firstHalfPaid) + "回 不足"; isHankiAlert = true;
            } else if (secondHalfPaid < 2) {
                hankiMsg = "下期があと " + (2 - secondHalfPaid) + "回 不足"; isHankiAlert = true;
            }
            
            checkAlert('cardHanki', 'alertHanki', isHankiAlert);
            if(isHankiAlert) document.getElementById('txtHanki').innerText = hankiMsg;
        }

        function checkAlert(cardId, msgId, isError) {
            const card = document.getElementById(cardId);
            const msg = document.getElementById(msgId);
            if (isError) {
                card.classList.add("warning");
                card.classList.remove("success");
                msg.style.display = "flex";
            } else {
                card.classList.remove("warning");
                card.classList.add("success");
                msg.style.display = "none";
            }
        }
    </script>
</body>
</html>