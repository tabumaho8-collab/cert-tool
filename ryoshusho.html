<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é ˜åè¨¼ä½œæˆãƒ„ãƒ¼ãƒ«</title>
    <style>
        /* --- å…¨ä½“ã®ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ --- */
        body {
            display: none; /* ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç”¨åˆæœŸéè¡¨ç¤º */
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            gap: 20px;
            justify-content: center;
            min-height: 100vh;
        }

        /* --- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚¨ãƒªã‚¢ --- */
        .editor-pane {
            width: 380px;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            height: fit-content;
            overflow-y: auto;
            max-height: 90vh;
        }
        
        /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
        .back-btn {
            display: inline-block;
            background-color: #6c757d;
            color: white;
            padding: 5px 10px;
            text-decoration: none;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 15px;
            cursor: pointer;
        }
        .back-btn:hover { background-color: #5a6268; }

        .editor-pane h2 { font-size: 18px; margin-bottom: 15px; border-bottom: 2px solid #ddd; padding-bottom: 5px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; font-size: 12px; font-weight: bold; margin-bottom: 5px; color: #555; }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%; padding: 8px; box-sizing: border-box;
            border: 1px solid #ccc; border-radius: 4px; font-size: 14px;
        }
        
        .item-row { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; }
        .item-row input { flex: 1; }
        .item-row .w-qty { width: 50px; flex: none; text-align: right; }
        .item-row .w-unit { width: 50px; flex: none; }
        .item-row .w-price { width: 80px; flex: none; text-align: right; }
        .item-row .w-tax { width: 60px; flex: none; }

        button.print-btn {
            width: 100%; padding: 12px; background-color: #2c517c;
            color: white; border: none; border-radius: 4px; font-size: 16px;
            cursor: pointer; font-weight: bold; margin-top: 10px;
        }
        button.print-btn:hover { background-color: #1a3655; }

        .preview-pane { flex-grow: 1; display: flex; justify-content: center; }
        
        #receipt {
            width: 210mm; min-height: 297mm; background: white; padding: 20mm;
            box-sizing: border-box; box-shadow: 0 5px 15px rgba(0,0,0,0.2); position: relative;
            font-family: "Yu Mincho", "YuMincho", serif; color: #333;
        }

        .header-top { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px; border-bottom: 1px solid #2c517c; padding-bottom: 5px; }
        .receipt-no { font-size: 14px; }
        .issue-date { font-size: 16px; }

        .title {
            text-align: center; font-size: 36px; font-weight: bold; color: #2c517c;
            letter-spacing: 10px; margin-bottom: 40px;
        }

        .info-section { display: flex; justify-content: space-between; margin-bottom: 30px; }
        .client-info { width: 50%; border-bottom: 1px solid #333; padding-bottom: 10px; align-self: flex-start; }
        .client-name { font-size: 22px; margin-bottom: 5px; }
        .issuer-info { width: 40%; font-size: 14px; line-height: 1.5; text-align: right; }
        .issuer-name { font-size: 18px; font-weight: bold; margin-bottom: 5px; }

        .amount-area { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 40px; }
        .amount-box { 
            background-color: #2c517c; color: white; padding: 15px 20px; 
            width: 60%; display: flex; justify-content: space-between; align-items: center;
        }
        .amount-label { font-size: 18px; font-weight: bold; }
        .total-amount { font-size: 32px; font-weight: bold; }
        
        .stamp-area { display: flex; gap: 10px; }
        .stamp-box { width: 70px; height: 80px; border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; font-size: 12px; color: #ccc; }

        .proviso { text-align: right; margin-top: 5px; margin-bottom: 20px; font-size: 14px; }

        .details-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 14px; }
        .details-table th { background-color: #dbe5f1; border: 1px solid #2c517c; padding: 8px; color: #2c517c; }
        .details-table td { border: 1px solid #2c517c; padding: 8px; vertical-align: middle; }
        .col-kubun { width: 30px; text-align: center; }
        .col-qty { width: 50px; text-align: right; }
        .col-unit { width: 40px; text-align: center; }
        .col-price { width: 80px; text-align: right; }
        .col-total { width: 90px; text-align: right; }

        .tax-summary { display: flex; justify-content: flex-end; margin-bottom: 20px; }
        .tax-table { border-collapse: collapse; width: 50%; font-size: 13px; }
        .tax-table td, .tax-table th { border: 1px solid #2c517c; padding: 5px 10px; text-align: right; }
        .tax-table th { background-color: #dbe5f1; color: #2c517c; font-weight: normal; }

        .remarks-box { border: 1px solid #2c517c; height: 100px; padding: 10px; font-size: 14px; vertical-align: top; }

        @media print {
            body { display: block !important; background: none; margin: 0; padding: 0; }
            .editor-pane { display: none; }
            .preview-pane { display: block; }
            #receipt { box-shadow: none; width: 100%; height: 100%; margin: 0; padding: 20mm; page-break-after: always; }
            @page { margin: 0; size: A4 portrait; }
        }
        @media (max-width: 900px) {
            body { flex-direction: column; align-items: center; }
            .editor-pane { width: 100%; max-width: 500px; }
            #receipt { width: 100%; font-size: 0.8em; padding: 10mm; }
        }
    </style>
</head>
<body>

    <script src="auth.js"></script>
    <script src="settings.js"></script>
    <script>
        if (typeof checkAuth === 'function') checkAuth(); else document.body.style.display = "flex";
        window.addEventListener('load', function() {
            if (typeof applyCompanyData === 'function') applyCompanyData();
            // è‡ªå‹•ãƒŠãƒ³ãƒãƒªãƒ³ã‚°èª­ã¿è¾¼ã¿
            loadReceiptNumber();
        });
    </script>

    <div class="editor-pane">
        <a href="index.html" class="back-btn">â¬… ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹</a>
        
        <h2>å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ </h2>
        
        <div class="form-group">
            <label>No. (è‡ªå‹•æ¡ç•ª)</label>
            <input type="text" id="iptNo" placeholder="è‡ªå‹•å…¥åŠ›" oninput="update()">
        </div>
        <div class="form-group">
            <label>ç™ºè¡Œæ—¥</label>
            <input type="date" id="iptDate">
        </div>
        <div class="form-group">
            <label>å®›åï¼ˆä¼šç¤¾åãƒ»éƒ¨ç½²ï¼‰</label>
            <input type="text" id="iptClient" placeholder="ã€‡ã€‡æ ªå¼ä¼šç¤¾ å–¶æ¥­éƒ¨ å¾¡ä¸­">
        </div>
        
        <hr>
        
        <label style="font-size:12px; font-weight:bold; color:#555;">æ˜ç´°ï¼ˆå“å / æ•°é‡ / å˜ä½ / å˜ä¾¡ / ç¨ï¼‰</label>
        <div id="items-container"></div>

        <div class="form-group">
            <label>ä½†ã—æ›¸ã</label>
            <input type="text" id="iptProviso" placeholder="å•†å“ä»£é‡‘ã¨ã—ã¦">
        </div>
        <div class="form-group">
            <label>å‚™è€ƒ</label>
            <textarea id="iptRemarks" rows="3"></textarea>
        </div>

        <hr>

        <h3>ç™ºè¡Œè€…æƒ…å ±</h3>
        <div class="form-group">
            <label>ä¼šç¤¾å</label>
            <input type="text" id="iptIssuerName" placeholder="æ ªå¼ä¼šç¤¾ã€‡ã€‡">
        </div>
        <div class="form-group">
            <label>ä½æ‰€ãƒ»TEL</label>
            <textarea id="iptIssuerAddr" rows="3" placeholder="ã€’000-0000 æ±äº¬éƒ½...&#13;TEL: 03-0000-0000"></textarea>
        </div>
        <div class="form-group">
            <label>ç™»éŒ²ç•ªå· (ã‚¤ãƒ³ãƒœã‚¤ã‚¹)</label>
            <input type="text" id="iptRegNo" placeholder="T1234567890123">
        </div>
        <div class="form-group">
            <label>æ‹…å½“è€…</label>
            <input type="text" id="iptIssuerRep" placeholder="å±±ç”° å¤ªéƒ">
        </div>

        <!-- å°åˆ·ãƒœã‚¿ãƒ³ï¼šæ©Ÿèƒ½ã‚’è¿½åŠ  -->
        <button class="print-btn" onclick="handlePrint()">ğŸ–¨ï¸ é ˜åè¨¼ã‚’å°åˆ· / PDFä¿å­˜</button>
    </div>

    <div class="preview-pane">
        <div id="receipt">
            <div class="header-top">
                <div class="receipt-no">No. <span id="viewNo"></span></div>
                <div class="issue-date" id="viewDate"></div>
            </div>

            <div class="title">é ˜ å è¨¼</div>

            <div class="info-section">
                <div class="client-info">
                    <div class="client-name" id="viewClient"></div>
                    <div style="font-size:12px; text-align:right;"></div>
                </div>
                <div class="issuer-info">
                    <div class="issuer-name" id="viewIssuerName"></div>
                    <div id="viewIssuerAddr" style="white-space: pre-wrap;"></div>
                    <div style="margin-top:5px;">æ‹…å½“ï¼š<span id="viewIssuerRep"></span></div>
                    <div style="margin-top:5px; border-bottom:1px solid #2c517c; display:inline-block;">ç™»éŒ²ç•ªå·ï¼š<span id="viewRegNo"></span></div>
                </div>
            </div>

            <div class="amount-area">
                <div class="amount-box">
                    <div class="amount-label">é ˜åé‡‘é¡</div>
                    <div class="total-amount">Â¥<span id="viewGrandTotal">0</span>-</div>
                </div>
                <div class="stamp-area">
                    <div class="stamp-box">åå…¥å°ç´™</div>
                    <div class="stamp-box">å°</div>
                </div>
            </div>

            <div class="proviso">
                ä½†ã—ã€<span id="viewProviso"></span>
                <br>ä¸Šè¨˜ã®é€šã‚Šæ­£ã«é ˜åã„ãŸã—ã¾ã—ãŸã€‚
            </div>

            <table class="details-table">
                <thead>
                    <tr>
                        <th class="col-kubun">åŒºåˆ†</th>
                        <th class="col-item">å“ ç›®</th>
                        <th class="col-qty">æ•° é‡</th>
                        <th class="col-unit">å˜ä½</th>
                        <th class="col-price">å˜ä¾¡(ç¨æŠœ)</th>
                        <th class="col-total">é‡‘é¡(ç¨æŠœ)</th>
                    </tr>
                </thead>
                <tbody id="viewItemsBody"></tbody>
            </table>
            
            <div style="font-size:10px; margin-bottom:5px;">
                åŒºåˆ†æ¬„ã«ã€Œâ€»ã€è¨˜è¼‰ã®ã‚ã‚‹å•†å“ã¯è»½æ¸›ç¨ç‡å¯¾è±¡ã§ã™ã€‚
            </div>

            <div class="tax-summary">
                <table class="tax-table">
                    <tr>
                        <th>ç¨ ç‡</th>
                        <th>10%</th>
                        <th>8% (è»½æ¸›)</th>
                    </tr>
                    <tr>
                        <th>å¯¾è±¡å°è¨ˆ</th>
                        <td id="viewSub10">0</td>
                        <td id="viewSub8">0</td>
                    </tr>
                    <tr>
                        <th>æ¶ˆè²»ç¨ç­‰</th>
                        <td id="viewTax10">0</td>
                        <td id="viewTax8">0</td>
                    </tr>
                    <tr style="background:#f9f9f9; font-weight:bold;">
                        <th>åˆ è¨ˆ</th>
                        <td colspan="2" id="viewTotalBottom">0</td>
                    </tr>
                </table>
            </div>

            <div style="font-size:12px; font-weight:bold; margin-bottom:5px;">å‚™è€ƒï¼š</div>
            <div class="remarks-box" id="viewRemarks"></div>
        </div>
    </div>

    <script>
        const ROW_COUNT = 6; 
        const KEY_RECEIPT_NO = "my_tool_receipt_seq"; // ä¿å­˜ç”¨ã®åå‰

        window.onload = function() {
            const container = document.getElementById('items-container');
            for(let i=0; i<ROW_COUNT; i++) {
                const div = document.createElement('div');
                div.className = 'item-row';
                div.innerHTML = `
                    <input type="text" class="ipt-item" placeholder="å“ç›®" oninput="update()">
                    <input type="number" class="ipt-qty w-qty" placeholder="æ•°" oninput="update()">
                    <input type="text" class="ipt-unit w-unit" placeholder="å˜ä½" oninput="update()">
                    <input type="number" class="ipt-price w-price" placeholder="å˜ä¾¡" oninput="update()">
                    <select class="ipt-tax w-tax" onchange="update()">
                        <option value="10">10%</option>
                        <option value="8">8%</option>
                    </select>
                `;
                container.appendChild(div);
            }
            document.getElementById('iptDate').valueAsDate = new Date();
            loadReceiptNumber(); // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ç•ªå·ã‚»ãƒƒãƒˆ
            update();
        };

        // ãƒŠãƒ³ãƒãƒ¼èª­ã¿è¾¼ã¿é–¢æ•°
        function loadReceiptNumber() {
            let current = localStorage.getItem(KEY_RECEIPT_NO);
            if (!current) current = "100001"; // åˆå›ã¯ã“ã“ã‹ã‚‰
            document.getElementById('iptNo').value = current;
            update();
        }

        // å°åˆ·ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã®å‡¦ç†
        function handlePrint() {
            // 1. å°åˆ·ç”»é¢ã‚’å‡ºã™
            window.print();

            // 2. å°åˆ·ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ãŒé–‰ã˜ãŸã‚‰ã€ç•ªå·ã‚’+1ã—ã¦ä¿å­˜ã™ã‚‹
            // (æ¬¡ã®ãŸã‚ã«ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã—ã¦ãŠã)
            let current = document.getElementById('iptNo').value;
            // æ•°å­—ä»¥å¤–ã®æ–‡å­—ã‚’å–ã‚Šé™¤ã„ã¦æ•°å€¤ã«ã™ã‚‹
            let num = parseInt(current.replace(/[^0-9]/g, ''), 10);
            
            if (!isNaN(num)) {
                let nextNum = num + 1;
                // ã‚¼ãƒ­åŸ‹ã‚ï¼ˆ6æ¡ï¼‰ã—ã¦ä¿å­˜
                let nextStr = String(nextNum).padStart(6, '0');
                localStorage.setItem(KEY_RECEIPT_NO, nextStr);
                
                // ç”»é¢ä¸Šã®ç•ªå·ã‚‚æ›´æ–°ï¼ˆç¶šã‘ã¦ç™ºè¡Œã™ã‚‹å ´åˆã®ãŸã‚ï¼‰
                document.getElementById('iptNo').value = nextStr;
                update();
            }
        }

        function fmt(num) { return num.toLocaleString(); }
        function formatDate(dateStr) {
            if(!dateStr) return "";
            const d = new Date(dateStr);
            return `${d.getFullYear()}å¹´${d.getMonth()+1}æœˆ${d.getDate()}æ—¥`;
        }

        function update() {
            document.getElementById('viewNo').innerText = document.getElementById('iptNo').value;
            document.getElementById('viewDate').innerText = formatDate(document.getElementById('iptDate').value);
            document.getElementById('viewClient').innerText = document.getElementById('iptClient').value;
            document.getElementById('viewIssuerName').innerText = document.getElementById('iptIssuerName').value;
            document.getElementById('viewIssuerAddr').innerText = document.getElementById('iptIssuerAddr').value;
            document.getElementById('viewIssuerRep').innerText = document.getElementById('iptIssuerRep').value;
            document.getElementById('viewRegNo').innerText = document.getElementById('iptRegNo').value;
            document.getElementById('viewProviso').innerText = document.getElementById('iptProviso').value;
            document.getElementById('viewRemarks').innerText = document.getElementById('iptRemarks').value;

            let html = '';
            let subTotal10 = 0;
            let subTotal8 = 0;
            const items = document.querySelectorAll('.item-row');
            
            items.forEach(row => {
                const name = row.querySelector('.ipt-item').value;
                const qty = parseFloat(row.querySelector('.ipt-qty').value);
                const unit = row.querySelector('.ipt-unit').value;
                const price = parseFloat(row.querySelector('.ipt-price').value);
                const taxRate = row.querySelector('.ipt-tax').value;

                if(name || price) {
                    const isValid = !isNaN(qty) && !isNaN(price);
                    const lineTotal = isValid ? (qty * price) : 0;
                    if(taxRate === "10") subTotal10 += lineTotal; else subTotal8 += lineTotal;
                    
                    const mark = (taxRate === "8") ? "â€»" : "";
                    html += `<tr><td class="col-kubun">${mark}</td><td>${name}</td><td class="col-qty">${isValid?qty:""}</td><td class="col-unit">${unit}</td><td class="col-price">${isValid?fmt(price):""}</td><td class="col-total">${isValid?fmt(lineTotal):""}</td></tr>`;
                } else {
                    html += `<tr><td class="col-kubun"></td><td></td><td></td><td></td><td></td><td></td></tr>`;
                }
            });
            document.getElementById('viewItemsBody').innerHTML = html;

            const tax10 = Math.floor(subTotal10 * 0.1);
            const tax8 = Math.floor(subTotal8 * 0.08);
            const total = subTotal10 + tax10 + subTotal8 + tax8;

            document.getElementById('viewSub10').innerText = fmt(subTotal10);
            document.getElementById('viewTax10').innerText = fmt(tax10);
            document.getElementById('viewSub8').innerText = fmt(subTotal8);
            document.getElementById('viewTax8').innerText = fmt(tax8);
            document.getElementById('viewTotalBottom').innerText = fmt(total);
            document.getElementById('viewGrandTotal').innerText = fmt(total);
        }
        document.querySelectorAll('input, textarea').forEach(i => i.addEventListener('input', update));
    </script>
</body>
</html>